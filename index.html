<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulador OPE Pinche</title>
    <link rel="stylesheet" href="css/style.css?v=16">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>

<body>
    <script src="js/script.js?v=16" defer></script>
    <!-- ACCESS OVERLAY -->
    <div id="access-overlay" class="login-overlay">
        <div class="login-box">
            <h2 id="access-title" style="color:var(--primary);">Verificando Acceso</h2>
            <p id="access-msg" style="font-weight: bold;">Por favor espere...</p>
        </div>
    </div>

    <!-- LOGIN OVERLAY -->
    <div id="login-overlay" class="login-overlay hidden">
        <div class="login-box">
            <h2 style="color:var(--primary);">Acceso Restringido</h2>
            <p>Introduce la contrase√±a para acceder al simulador:</p>
            <input type="password" id="login-password" placeholder="Contrase√±a..." />
            <button id="btn-login" class="btn-primary">Acceder</button>
            <p id="login-error" class="error-text hidden">Contrase√±a incorrecta.</p>
        </div>
    </div>

    <!-- ADMIN MODAL -->
    <div id="admin-modal" class="modal hidden">
        <div class="modal-content">
            <header class="modal-header">
                <h2 style="margin:0; font-size:1.5rem; color:var(--primary);">Registros de Acceso</h2>
                <button id="btn-close-admin" class="btn-icon">‚úñ</button>
            </header>
            <div class="table-container">
                <table class="progress-table">

                    <tbody id="admin-table-body">
                        <!-- Logs here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- VISTA: SELECCI√ìN DE ROL (Inicio) -->
        <div id="view-role-selection" class="view active">
            <h1>Simulador OPE SESCAM</h1>
            <p class="subtitle">Elige tu categor√≠a profesional</p>

            <div class="menu-grid">
                <button id="btn-role-pinche" class="btn-menu special">
                    üç≥ Ayudante de Cocina (Pinche)
                    <span class="badge">Disponible</span>
                </button>
                <button id="btn-role-celador" class="btn-menu">
                    üöë Celador
                    <span class="badge" style="background:var(--text-light); color:white;">Pr√≥ximamente</span>
                </button>
            </div>
            <button id="btn-admin-panel" class="btn-secondary"
                style="margin-top:40px; width:100%; font-size:0.9rem; opacity:0.8;">Ver Conexiones (Admin)</button>
            <p style="text-align:center; margin-top:15px; color:#aaa; font-size:0.8rem;">
                v1.13.0 (Security) - M√°s categor√≠as en desarrollo<br>
                <span id="licencia-activa" style="color: #4CAF50; font-weight: bold; display: none; margin-top: 5px;">‚úì
                    Licencia activa</span>
            </p>
        </div>

        <!-- VISTA: MEN√ö PRINCIPAL (Pinche) -->
        <div id="view-menu" class="view hidden">
            <header class="view-header"
                style="position: relative; justify-content: center; margin-bottom: 5px; border: none; padding-bottom: 0; min-height: 50px;">
                <button id="btn-back-menu" class="btn-icon"
                    style="position:absolute; left:0; top: 50%; transform: translateY(-50%);">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"
                        stroke-linecap="round" stroke-linejoin="round">
                        <path d="M19 12H5M12 19l-7-7 7-7" />
                    </svg>
                </button>
                <h1 style="margin:0;">Simulador OPE Pinche</h1>
            </header>
            <p class="subtitle" style="text-align: center; margin-bottom: 25px;">Selecciona una fuente de estudio</p>

            <div class="menu-grid">
                <!-- Nivel Maestro: Selecci√≥n de Fuente -->
                <button id="btn-source-mad" class="btn-menu">
                    üìö Tests MAD
                </button>
                <button id="btn-source-csif" class="btn-menu">
                    üè• Tests CSIF
                </button>
                <button id="btn-source-academia" class="btn-menu">
                    üéì Tests Academia
                    <span class="badge">Pronto</span>
                </button>
                <button id="btn-source-examenes" class="btn-menu special">
                    üìÖ Ex√°menes A√±os Anteriores
                    <span class="badge">Reales</span>
                </button>

                <!-- Otras Funciones -->
                <button id="btn-failures" class="btn-menu special-red" style="grid-column: 1 / -1;">
                    üß† Repasar Fallos
                    <span class="badge" id="badge-failures">0</span>
                </button>
                <button id="btn-random" class="btn-menu">
                    üé≤ Modo Aleatorio
                    <span class="badge">Global</span>
                </button>
                <button id="btn-progress" class="btn-menu">
                    üìä Mi Progreso
                    <span class="badge">Estad√≠sticas</span>
                </button>
            </div>
            <p style="text-align:center; color:#999; margin-top:20px; font-size:0.8rem;">M√°s funciones pr√≥ximamente...
            </p>
        </div>

        <!-- VISTA: SELECCI√ìN DE PARTE (General / Espec√≠fica) -->
        <div id="view-parts" class="view hidden">
            <header class="view-header">
                <button id="btn-back-parts" class="btn-icon"><svg width="24" height="24" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M19 12H5M12 19l-7-7 7-7" />
                    </svg></button>
                <h2 id="parts-title">Fuente Seleccionada</h2>
            </header>

            <div class="menu-grid">
                <button id="btn-part-general" class="btn-menu">
                    üìö Parte General
                    <span class="badge">Temas 1 al 6</span>
                </button>
                <button id="btn-part-especifica" class="btn-menu">
                    üè• Parte Espec√≠fica
                    <span class="badge">Temas 7 al 16</span>
                </button>
            </div>
        </div>

        <!-- VISTA: MEN√ö EX√ÅMENES OPE 2020 -->
        <div id="view-exams-menu" class="view hidden">
            <header class="view-header">
                <button id="btn-back-exams" class="btn-icon"><svg width="24" height="24" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M19 12H5M12 19l-7-7 7-7" />
                    </svg></button>
                <h2>Ex√°menes A√±os Anteriores</h2>
            </header>

            <h3
                style="text-align:center; color:var(--primary); margin-top:20px; border-bottom: 2px solid #eee; padding-bottom: 10px;">
                OPE SESCAM 2020</h3>

            <div class="menu-grid">
                <button id="btn-2020-ord" class="btn-menu">
                    üìÖ Examen Ordinario
                    <span class="badge">OPE 2020 (Examen 2021)</span>
                </button>
                <button id="btn-2020-extra" class="btn-menu">
                    üìÖ Examen Extraordinario
                    <span class="badge">OPE 2020 (Examen 2022)</span>
                </button>
            </div>

            <h3
                style="text-align:center; color:var(--primary); margin-top:20px; border-bottom: 2px solid #eee; padding-bottom: 10px;">
                M√°s Contenido Hist√≥rico</h3>

            <div class="menu-grid">
                <button id="btn-examenes-ccaa" class="btn-menu">
                    üåç Otras CCAA
                </button>
                <button id="btn-examenes-historico" class="btn-menu">
                    üï∞Ô∏è Hist√≥rico de Preguntas
                </button>
            </div>
        </div>

        <!-- VISTA: SELECCI√ìN DE MODALIDAD (Entrenamiento vs Examen) -->
        <div id="view-mode-selection" class="view hidden">
            <header class="view-header">
                <button id="btn-back-mode" class="btn-icon"><svg width="24" height="24" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M19 12H5M12 19l-7-7 7-7" />
                    </svg></button>
                <h2>Configura tu Test</h2>
            </header>

            <div class="card" style="text-align:center;">
                <h3 id="mode-topic-title">Tema Seleccionado</h3>
                <p>Elige c√≥mo quieres realizar este test:</p>

                <div class="mode-grid">
                    <button id="btn-mode-training" class="btn-mode">
                        <span class="icon">üèãÔ∏è‚Äç‚ôÄÔ∏è</span>
                        <strong>Entrenamiento</strong>
                        <small>Correcci√≥n inmediata. Ideal para estudiar.</small>
                    </button>
                    <button id="btn-mode-exam" class="btn-mode">
                        <span class="icon">‚è±</span>
                        <strong>Simulacro Examen</strong>
                        <small>Sin correcci√≥n hasta el final. Nota real.</small>
                    </button>
                </div>
            </div>
        </div>

        <!-- VISTA: SELECCI√ìN DE TEMAS -->
        <div id="view-topics" class="view hidden">
            <header class="view-header">
                <button id="btn-back-topics" class="btn-icon"><svg width="24" height="24" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M19 12H5M12 19l-7-7 7-7" />
                    </svg></button>
                <h2 id="topic-title">Temas</h2>
            </header>

            <div id="topics-container" class="topics-wrapper">
                <!-- Se rellena con JS: Generales y Espec√≠ficos -->
            </div>
        </div>

        <!-- VISTA: MI PROGRESO -->
        <div id="view-progress" class="view hidden">
            <header class="view-header">
                <button id="btn-back-progress" class="btn-icon"><svg width="24" height="24" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M19 12H5M12 19l-7-7 7-7" />
                    </svg></button>
                <h2>Mi Historial</h2>
            </header>

            <div class="card">
                <div style="overflow-x:auto;">
                    <table class="progress-table">
                        <thead>
                            <tr>
                                <th>Fecha</th>
                                <th>Test</th>
                                <th>Nota</th>
                            </tr>
                        </thead>
                        <tbody id="progress-body">
                            <!-- JS -->
                        </tbody>
                    </table>
                </div>
                <button id="btn-clear-history" class="btn-small"
                    style="margin-top:15px; background:#ffeba7; color:#555;">Borrar Historial</button>
            </div>
        </div>

        <!-- VISTA: CONFIGURACI√ìN ALEATORIA -->
        <div id="view-random" class="view hidden">
            <header class="view-header">
                <button id="btn-back-random" class="btn-icon"><svg width="24" height="24" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M19 12H5M12 19l-7-7 7-7" />
                    </svg></button>
                <h2>Modo Aleatorio Avanzado</h2>
            </header>
            <div class="config-box" style="text-align: left;">
                <label style="font-weight:bold; display:block; margin-bottom:5px;">1. Tipo de Mezcla Principal:</label>
                <select id="select-mix-type" class="form-control"
                    style="width:100%; padding:10px; margin-bottom:15px; border-radius:8px; border:2px solid var(--primary);">
                    <option value="general">üåç General Total (Toda la base de datos)</option>
                    <option value="origen">üìö Filtrar por Editorial (Origen)</option>
                    <option value="oficial">üèõÔ∏è Ex√°menes Oficiales e Hist√≥ricos</option>
                    <option value="tema">üè∑Ô∏è Por Tema Individual</option>
                </select>

                <!-- Sub-filtro Origen -->
                <div id="filter-group-origen" class="filter-group hidden">
                    <label style="font-weight:bold; display:block; margin-bottom:5px;">Selecciona la Editorial:</label>
                    <select id="select-origen" class="form-control"
                        style="width:100%; padding:10px; margin-bottom:15px; border-radius:8px;">
                        <option value="CSIF">CSIF</option>
                        <option value="MAD">MAD</option>
                        <option value="Academia Test">Academia Test</option>
                    </select>
                </div>

                <!-- Sub-filtro Oficial -->
                <div id="filter-group-oficial" class="filter-group hidden">
                    <label style="font-weight:bold; display:block; margin-bottom:5px;">Selecciona Tipo de
                        Examen:</label>
                    <select id="select-oficial" class="form-control"
                        style="width:100%; padding:10px; margin-bottom:15px; border-radius:8px;">
                        <option value="todos">Todos los Oficiales</option>
                        <option value="SESCAM">OPE SESCAM</option>
                        <option value="Otras">Otras Comunidades</option>
                    </select>
                </div>

                <!-- Sub-filtro Tema -->
                <div id="filter-group-tema" class="filter-group hidden">
                    <label style="font-weight:bold; display:block; margin-bottom:5px;">Elige el Tema:</label>
                    <select id="select-tema-num" class="form-control"
                        style="width:100%; padding:10px; margin-bottom:15px; border-radius:8px;">
                        <!-- JS fills options 1 to 16 -->
                    </select>

                    <label style="font-weight:bold; display:block; margin-bottom:5px;">Filtro de Fuente
                        (Opcional):</label>
                    <select id="select-tema-fuente" class="form-control"
                        style="width:100%; padding:10px; margin-bottom:15px; border-radius:8px;">
                        <option value="todas">Todas las fuentes</option>
                        <option value="CSIF">CSIF</option>
                        <option value="MAD">MAD</option>
                    </select>
                </div>

                <div style="border-top: 1px solid #ddd; margin-top: 10px; padding-top: 15px; text-align:center;">
                    <label style="font-weight:bold; display:block;">¬øCu√°ntas preguntas?</label>
                    <input type="number" id="random-count" min="1" max="100" value="20">
                    <p style="font-size:0.8rem; color:#777; margin-top:0;">M√°ximo 100.</p>
                </div>
                <br>
                <button id="btn-start-random" class="btn-primary">Comenzar Test Aleatorio <svg width="24" height="24"
                        viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M5 12h14M12 5l7 7-7 7" />
                    </svg></button>
            </div>
        </div>

        <!-- VISTA: JUEGO (SIMULADOR) -->
        <div id="view-game" class="view hidden">
            <header class="game-header">
                <button id="btn-quit-game" class="btn-back"><svg width="24" height="24" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M19 12H5M12 19l-7-7 7-7" />
                    </svg></button>

                <!-- NEW FEATURE: "Borrar Fallos" header button -->
                <button id="btn-clear-failures-header" class="btn-small hidden"
                    style="background-color: #f44336; color: white; display: flex; align-items: center; justify-content: center; border-radius: 4px; padding: 4px 8px; margin-left: 10px; font-weight: bold; border: 1px solid #d32f2f; cursor: pointer;">
                    üóëÔ∏è Vaciar
                </button>

                <!-- GAMIFICATION PROGRESS BAR -->
                <div class="progress-container"
                    style="flex-grow: 1; margin: 0 15px; background: #ddd; height: 10px; border-radius: 5px; overflow: hidden;">
                    <div id="progress-bar" class="progress-bar"
                        style="height: 100%; background: var(--secondary); width: 0%; transition: width 0.3s ease;">
                    </div>
                </div>

                <div class="counters">
                    <button id="btn-show-grid" class="btn-small"
                        style="margin-right:10px; padding:2px 8px; font-size:1.2rem;">‚ñ¶</button>
                    <span id="question-counter">1/--</span>
                    <span id="score-badge" class="badge-score">Aciertos: 0</span>
                </div>
            </header>

            <!-- NAV GRID OVERLAY -->
            <div id="nav-grid-overlay" class="grid-overlay hidden">
                <div class="grid-content">
                    <h3>Navegaci√≥n de Preguntas (<span id="grid-total"></span>)</h3>
                    <div id="grid-buttons" class="grid-buttons-container"></div>
                    <button id="btn-close-grid" class="btn-primary" style="margin-top:20px;">Cerrar</button>
                </div>
            </div>

            <div class="card question-card">
                <div class="card-header">
                    <span id="tema-tag" class="tag">Tema</span>
                    <span id="mode-tag" class="tag"
                        style="background:#e8f5e9; color:#2e7d32; margin-left:5px;">Modo</span>
                </div>
                <div class="card-body">
                    <h2 id="pregunta-texto">Cargando...</h2>
                    <div id="opciones-container" class="options-grid"></div>
                </div>
                <div id="feedback" class="feedback hidden">
                    <p id="explicacion"></p>
                </div>
            </div>

            <div class="controls">
                <button id="btn-prev" class="btn-secondary hidden" style="margin-right:10px;"><svg width="24"
                        height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"
                        stroke-linecap="round" stroke-linejoin="round">
                        <path d="M19 12H5M12 19l-7-7 7-7" />
                    </svg> Anterior</button>
                <button id="btn-next" class="btn-primary hidden">Siguiente <svg width="24" height="24"
                        viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M5 12h14M12 5l7 7-7 7" />
                    </svg></button>
            </div>
        </div>

        <!-- VISTA: RESULTADOS -->
        <div id="view-results" class="view hidden">
            <div class="card" style="text-align:center;">
                <h2>Resultados</h2>
                <div class="score-circle">
                    <span id="final-score">0</span>
                    <span class="total" id="final-total">/ 0</span>
                </div>

                <!-- GAMIFICACI√ìN FEEDBACK -->
                <div id="resultado-motivacional"
                    style="margin:20px 0; padding:15px; border-radius:10px; background:#f4f6f8;">
                    <h3 id="resultado-porcentaje" style="font-size:2.5rem; color:var(--primary); margin:0;">0%</h3>
                    <p id="resultado-texto"
                        style="font-size:1.1rem; font-weight:bold; margin-top:10px; color:var(--text);"></p>
                </div>

                <p id="final-message" class="hidden" style="font-size:1.2rem; font-weight:bold;">¬°Bien hecho!</p>

                <div id="exam-feedback-container" class="hidden" style="text-align:left; margin-top:20px;">
                    <!-- Aqu√≠ ir√≠a el desglose si quisi√©ramos, por ahora simple -->
                </div>

                <div style="margin-top:30px; display:flex; gap:10px; justify-content:center; flex-wrap:wrap;">
                    <button id="btn-review-exam" class="btn-primary hidden" style="background:#2196f3;">üîç Todo</button>
                    <button id="btn-review-failed" class="btn-primary hidden" style="background:#ff9800;">üîç Solo
                        Fallos</button>
                    <button id="btn-clear-failures" class="btn-secondary hidden"
                        style="background:#f44336; color:white; margin-top:10px;">üóëÔ∏è Borrar Fallos Hist√≥ricos</button>
                    <button id="btn-retry" class="btn-primary" style="background:var(--secondary);">Repetir
                        Test</button>
                    <button id="btn-home-results" class="btn-primary">Volver al Men√∫</button>
                </div>
            </div>
        </div>

    </div>

    <script src="js/script.js?v=16"></script>
</body>

</html>